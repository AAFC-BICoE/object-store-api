<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd" objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">

  <changeSet id="5-Add_acSubType_for_metadata" context="schema-change" author="keyuk">

    <!-- Add the column -->
    <addColumn tableName="metadata">
      <column name="ac_sub_type_id" type="INTEGER" />
    </addColumn>

    <!-- Foreign key constraint -->
    <addForeignKeyConstraint
      baseColumnNames="ac_sub_type_id"
      baseTableName="metadata"
      constraintName="fk_metadata_ac_sub_type_id"
      referencedColumnNames="id"
      referencedTableName="object_subtype"/>

    <!-- Add check to prevent trailing whitespace for object_subtype -->
    <sql>
      ALTER TABLE object_subtype
        ADD CONSTRAINT check_white_space_ac_subtype
        CHECK (trim(ac_subtype) = ac_subtype);
    </sql>

    <!-- Alter unquie constraint for object_subtype to be case insensitive-->
    <sql>
      ALTER TABLE object_subtype
        DROP CONSTRAINT unique_dctype_acsubtype_combination_per_object;

      CREATE UNIQUE INDEX unique_dctype_acsubtype_combination_per_object
        ON object_subtype ((lower(ac_subtype)), dc_type);
    </sql>
  </changeSet>

</databaseChangeLog>

